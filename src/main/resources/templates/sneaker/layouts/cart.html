<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Корзина</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center mb-4">Ваша корзина</h2>

    <div th:unless="${cartEmpty}">
        <div class="row">
            <div class="col-md-8">
                <div class="list-group">
                    <div th:each="item : ${cartItems}"
                         class="cart-item list-group-item d-flex align-items-center justify-content-between"
                         th:data-item-id="${item.id}">
                        <div class="d-flex align-items-center">
                            <img th:if="${item.sneaker.imageUrl != null}"
                                 th:src="@{'/img/' + ${item.sneaker.imageUrl}}"
                                 alt="Sneaker Image"
                                 style="width: 100px; height: auto;"/>
                            <div class="ms-3">
                                <h5 th:text="${item.sneaker.name}">Sneaker Name</h5>
                                <p th:text="${item.sneaker.brand}">Бренд</p>
                                <p th:text="'Размер: ' + ${item.size}">Размер</p>
                                <p th:text="'Цена: ' + ${#numbers.formatDecimal(item.sneaker.price, 1, 2)} + ' ₽'">Цена</p>
                                <div class="quantity-controls">
                                    <button class="btn btn-sm btn-outline-secondary decrease-qty">-</button>
                                    <input type="number" class="form-control-sm quantity-input"
                                           th:value="${item.quantity}" min="1" style="width: 60px"/>
                                    <button class="btn btn-sm btn-outline-secondary increase-qty">+</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-outline-danger btn-sm remove-item"
                                th:data-item-id="${item.id}">
                            <i class="fas fa-trash"></i> Удалить
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Итого</h5>
                        <p class="card-text" th:text="'Общая сумма: ' + ${#numbers.formatDecimal(cart.totalPrice, 1, 2)} + ' ₽'"></p>
                        <a href="/" class="btn btn-secondary mb-2">Продолжить покупки</a>
                        <form th:action="@{/order/create}" method="post" class="checkout-form">
                            <input type="hidden" name="cartId" th:value="${cart.id}">
                            <button type="submit" class="btn btn-primary w-100">Оформить заказ</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <style>
        .cart-item {
            transition: all 0.3s ease;
        }
        .cart-item.removing {
            transform: translateX(100%);
            opacity: 0;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Обработка удаления товара
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const itemId = this.getAttribute('data-item-id');

                    if (confirm('Вы уверены, что хотите удалить этот товар?')) {
                        const cartItem = this.closest('.cart-item');
                        cartItem.classList.add('removing');

                        try {
                            const response = await fetch(`/cart/remove/${itemId}`, {
                                method: 'POST'
                            });

                            if (response.ok) {
                                await new Promise(resolve => setTimeout(resolve, 300));
                                cartItem.remove();
                                updateCartTotal();
                            }
                        } catch (error) {
                            console.error('Error removing item:', error);
                            cartItem.classList.remove('removing');
                        }
                    }
                });
            });
            // Обработка изменения количества
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', async function() {
                    const itemId = this.closest('.cart-item').getAttribute('data-item-id');
                    const newQuantity = this.value;

                    try {
                        const response = await fetch(`/cart/update/${itemId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ quantity: newQuantity })
                        });

                        if (response.ok) {
                            updateCartTotal();
                        }
                    } catch (error) {
                        console.error('Error updating quantity:', error);
                    }
                });
            });
            // Кнопки +/-
            document.querySelectorAll('.increase-qty').forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    input.value = parseInt(input.value) + 1;
                    input.dispatchEvent(new Event('change'));
                });
            });
            document.querySelectorAll('.decrease-qty').forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.nextElementSibling;
                    if (parseInt(input.value) > 1) {
                        input.value = parseInt(input.value) - 1;
                        input.dispatchEvent(new Event('change'));
                    }
                });
            });
            function updateCartTotal() {
                // Обновление общей суммы через AJAX
                fetch('/cart/total')
                    .then(response => response.json())
                    .then(data => {
                        document.querySelector('.card-text').textContent =
                            `Общая сумма: ${data.totalPrice.toFixed(2)} ₽`;
                    });
            }
        });
    </script>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
